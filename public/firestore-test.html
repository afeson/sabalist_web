<!DOCTYPE html>
<html>
<head>
    <title>Firestore Direct Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }
        .log { margin: 5px 0; padding: 5px; background: #000; border-left: 3px solid #00ff00; }
        .error { border-left-color: #ff0000; color: #ff0000; }
        .success { border-left-color: #00ff00; color: #00ff00; }
        .info { border-left-color: #ffaa00; color: #ffaa00; }
    </style>
</head>
<body>
    <h1>üî• Firestore Direct Connection Test</h1>
    <div id="output"></div>

    <script type="module">
        const output = document.getElementById('output');

        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            output.appendChild(div);
            console.log(msg);
        }

        try {
            log('Loading Firebase modules...', 'info');

            const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
            const { getFirestore, collection, addDoc, serverTimestamp, connectFirestoreEmulator } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const { getAuth, signInAnonymously } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');

            log('‚úì Firebase modules loaded', 'success');

            const firebaseConfig = {
                apiKey: "AIzaSyBTy0WJrU9YCCBzlseDjpbhu9RGYvyQ7sk",
                authDomain: "sabalist.firebaseapp.com",
                projectId: "sabalist",
                storageBucket: "sabalist.firebasestorage.app",
                messagingSenderId: "231273918004",
                appId: "1:231273918004:web:0020dcc14b7f52e3356461"
            };

            log('Initializing Firebase app...', 'info');
            const app = initializeApp(firebaseConfig);
            log('‚úì Firebase app initialized', 'success');

            log('Getting Firestore instance...', 'info');
            const db = getFirestore(app);
            log(`‚úì Firestore instance: ${db.type}`, 'success');

            log('Getting Auth instance...', 'info');
            const auth = getAuth(app);
            log('‚úì Auth instance obtained', 'success');

            log('Signing in anonymously...', 'info');
            const userCred = await signInAnonymously(auth);
            log(`‚úì Signed in: ${userCred.user.uid}`, 'success');

            // Test with minimal data first
            log('Creating minimal test document...', 'info');
            const minimalData = {
                test: 'minimal',
                timestamp: serverTimestamp(),
                userId: userCred.user.uid
            };

            log(`Calling addDoc with: ${JSON.stringify(minimalData)}`, 'info');
            const startTime = Date.now();

            const docRef = await addDoc(collection(db, 'listings'), minimalData);
            const elapsed = Date.now() - startTime;

            log(`‚úÖ SUCCESS! Document created: ${docRef.id} (${elapsed}ms)`, 'success');
            log(`Full path: listings/${docRef.id}`, 'success');

            // Now try with full listing data
            log('Creating full listing document...', 'info');
            const fullData = {
                title: 'Test Listing',
                category: 'Electronics',
                price: 100,
                userId: userCred.user.uid,
                status: 'active',
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                images: [],
                coverImage: '',
                videoUrl: '',
                views: 0,
                description: 'Test',
                location: 'Test',
                phoneNumber: '+254712345678',
                subcategory: '',
                currency: 'USD'
            };

            const startTime2 = Date.now();
            const docRef2 = await addDoc(collection(db, 'listings'), fullData);
            const elapsed2 = Date.now() - startTime2;

            log(`‚úÖ FULL SUCCESS! Document created: ${docRef2.id} (${elapsed2}ms)`, 'success');

        } catch (error) {
            log(`‚ùå ERROR: ${error.message}`, 'error');
            log(`Stack: ${error.stack}`, 'error');
            console.error('Full error:', error);
        }
    </script>
</body>
</html>
