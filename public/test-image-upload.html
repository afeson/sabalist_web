<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Test Image Upload - DIRECT</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin: 10px 5px;
    }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .log {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 500px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .success { color: #155724; background: #d4edda; padding: 10px; border-radius: 4px; }
    .error { color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; }
    input[type="file"] {
      margin: 15px 0;
      padding: 10px;
      border: 2px dashed #007bff;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Direct Image Upload Test</h1>
    <p>This page tests image upload WITHOUT any app code caching</p>

    <div id="authStatus">Checking auth...</div>

    <input type="file" id="fileInput" accept="image/*" />
    <button onclick="testUpload()" id="uploadBtn">üì§ Upload Image</button>
    <button onclick="clearLog()">üóëÔ∏è Clear Log</button>

    <div id="log" class="log"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBwvEh8cW_tI0FWXbLY0Sd7QIUX8jNhp94",
      authDomain: "sabalist-afeson.firebaseapp.com",
      projectId: "sabalist-afeson",
      storageBucket: "sabalist-afeson.firebasestorage.app",
      messagingSenderId: "539257649722",
      appId: "1:539257649722:web:5e916bdb7cb5da46f74936",
      measurementId: "G-4GD70C41YZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);

    let logMessages = [];

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
      const msg = `[${timestamp}] ${prefix} ${message}`;
      logMessages.push(msg);
      document.getElementById('log').textContent = logMessages.join('\n');
      console.log(msg);
    }

    window.clearLog = function() {
      logMessages = [];
      document.getElementById('log').textContent = '';
    };

    // Monitor auth state
    onAuthStateChanged(auth, (user) => {
      const status = document.getElementById('authStatus');
      if (user) {
        status.innerHTML = `<div class="success">‚úÖ Signed in: ${user.email || 'Anonymous'} (${user.uid})</div>`;
        log(`Auth: Signed in as ${user.email || 'Anonymous'}`, 'success');
      } else {
        status.innerHTML = `<div class="error">‚ùå Not signed in - <a href="/quick-signin.html">Sign in first</a></div>`;
        log('Auth: Not signed in', 'error');
      }
    });

    window.testUpload = async function() {
      const uploadBtn = document.getElementById('uploadBtn');
      const fileInput = document.getElementById('fileInput');

      uploadBtn.disabled = true;
      log('========== UPLOAD TEST STARTED ==========', 'info');

      try {
        // Check auth
        const user = auth.currentUser;
        if (!user) {
          log('ERROR: Not signed in! Go to /quick-signin.html first', 'error');
          uploadBtn.disabled = false;
          return;
        }

        // Check file selected
        if (!fileInput.files || !fileInput.files[0]) {
          log('ERROR: No file selected', 'error');
          uploadBtn.disabled = false;
          return;
        }

        const file = fileInput.files[0];
        log(`File selected: ${file.name}, ${(file.size / 1024).toFixed(2)} KB`, 'info');

        // Convert to data URL (like the app does)
        log('Converting file to data URL...', 'info');
        const dataURL = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
        log(`Data URL created: ${dataURL.substring(0, 50)}...`, 'info');

        // Parse data URL
        const matches = dataURL.match(/^data:([^;]+);base64,(.+)$/);
        if (!matches) {
          throw new Error('Invalid data URL format');
        }
        const mimeType = matches[1];
        const base64Data = matches[2];
        log(`MIME: ${mimeType}, base64 length: ${base64Data.length} chars`, 'info');

        // Convert to Blob (EXACTLY like uploadHelpers.js does)
        log('Converting base64 to Blob...', 'info');
        const binaryString = atob(base64Data);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        const blob = new Blob([bytes], { type: mimeType });
        log(`Blob created: ${(blob.size / 1024).toFixed(2)} KB`, 'success');

        // Create storage reference
        const storagePath = `test-uploads/${user.uid}/test-${Date.now()}.jpg`;
        log(`Creating storage ref: ${storagePath}`, 'info');
        log(`Storage object type: ${typeof storage}`, 'info');
        log(`ref function type: ${typeof ref}`, 'info');

        const storageRef = ref(storage, storagePath);
        log(`Storage ref created: ${!!storageRef}`, 'success');

        // Upload blob
        log('Uploading blob to Firebase Storage...', 'info');
        const uploadResult = await uploadBytes(storageRef, blob);
        log(`Upload complete! Metadata size: ${uploadResult.metadata.size} bytes`, 'success');

        // Get download URL
        log('Getting download URL...', 'info');
        const downloadURL = await getDownloadURL(storageRef);
        log(`SUCCESS! Download URL: ${downloadURL}`, 'success');

        log('========== UPLOAD TEST COMPLETED ==========', 'success');
        alert(`‚úÖ Success! Image uploaded.\n\nURL: ${downloadURL.substring(0, 80)}...`);

      } catch (error) {
        log(`FAILED: ${error.message}`, 'error');
        log(`Error code: ${error.code || 'none'}`, 'error');
        log(`Error stack: ${error.stack}`, 'error');
        alert(`‚ùå Upload failed:\n${error.message}`);
      } finally {
        uploadBtn.disabled = false;
      }
    };

    // Log on page load
    log('Page loaded. Select an image and click Upload.', 'info');
  </script>
</body>
</html>
